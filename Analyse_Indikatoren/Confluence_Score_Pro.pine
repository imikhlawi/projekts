// @version=5
// =============================================================================
// CONFLUENCE SCORE PRO — Trade Readiness Gauge (0–100)
// =============================================================================
// Combines MA trend, RSI, ADX, VWAP and optional volume into a single 0–100
// "confluence score". Displays in a separate pane with gauge-style bar and
// optional multi-timeframe comparison. Use for quick bias: 0 = bearish, 100 = bullish.
// =============================================================================

indicator("Confluence Score Pro", shorttitle="CS Pro", overlay=false, format=format.integer, precision=0, max_bars_back=500)

// —————————————————————————————————————————————————————————————————————————————
// [1] INPUTS
// —————————————————————————————————————————————————————————————————————————————

g_score = "Score Settings"
i_ma_fast = input.int(21, "MA Fast", group=g_score, inline="ma")
i_ma_slow = input.int(55, "MA Slow", group=g_score, inline="ma")
i_rsi_len = input.int(14, "RSI Length", group=g_score)
i_rsi_bull = input.int(50, "RSI Bullish Below", group=g_score, inline="rsi")
i_rsi_bear = input.int(50, "RSI Bearish Above", group=g_score, inline="rsi")
i_adx_len = input.int(14, "ADX Length", group=g_score)
i_adx_min = input.int(20, "ADX Min", group=g_score)
i_vol_weight = input.bool(false, "Include Volume Confirmation", group=g_score)

g_display = "Display"
i_show_gauge = input.bool(true, "Show Gauge Bar", group=g_display)
i_show_table = input.bool(true, "Show Breakdown Table on Chart", group=g_display)
i_table_pos = input.string("Top Right", "Table Position", options=["Top Right", "Top Left", "Middle Right", "Bottom Right"], group=g_display)
i_htf = input.timeframe("", "Higher Timeframe (optional)", group=g_display)
i_show_htf = input.bool(true, "Show HTF Score in Table", group=g_display)

g_alerts = "Thresholds"
i_strong_long = input.int(75, "Strong Long Above", minval=50, maxval=100, group=g_alerts)
i_strong_short = input.int(25, "Strong Short Below", minval=0, maxval=50, group=g_alerts)

// —————————————————————————————————————————————————————————————————————————————
// [2] CALCULATIONS
// —————————————————————————————————————————————————————————————————————————————

ma_fast = ta.ema(close, i_ma_fast)
ma_slow = ta.ema(close, i_ma_slow)
rsi_val = ta.rsi(close, i_rsi_len)
[di_plus, di_minus, adx] = ta.dmi(i_adx_len, i_adx_len)
vwap_val = ta.vwap
vol_ma = ta.sma(volume, 20)
vol_ok = volume >= vol_ma * 0.8

// Component signals (1 = bullish, 0 = neutral, -1 bearish for score)
ma_bull = ma_fast > ma_slow ? 1 : 0
ma_bear = ma_fast < ma_slow ? 1 : 0
rsi_bull = rsi_val < i_rsi_bull ? 1 : 0
rsi_bear = rsi_val > i_rsi_bear ? 1 : 0
adx_ok = adx > i_adx_min
adx_bull = adx_ok and di_plus > di_minus ? 1 : 0
adx_bear = adx_ok and di_minus > di_plus ? 1 : 0
vwap_bull = close > vwap_val ? 1 : 0
vwap_bear = close < vwap_val ? 1 : 0
vol_bull = not i_vol_weight ? 0 : (close > open and vol_ok ? 1 : 0)
vol_bear = not i_vol_weight ? 0 : (close < open and vol_ok ? 1 : 0)

n = 4.0 + (i_vol_weight ? 1.0 : 0.0)
bull_sum = (ma_bull + rsi_bull + adx_bull + vwap_bull + vol_bull)
bear_sum = (ma_bear + rsi_bear + adx_bear + vwap_bear + vol_bear)
score_raw = (bull_sum - bear_sum) / n
score_0_100 = math.round(50 + 50 * math.max(-1, math.min(1, score_raw)))

// HTF score
score_htf = i_htf != "" ? request.security(syminfo.tickerid, i_htf, score_0_100, barmerge.gaps_off, barmerge.lookahead_on) : na

// Gauge color
score_color = score_0_100 >= i_strong_long ? color.new(color.green, 20) : score_0_100 <= i_strong_short ? color.new(color.red, 20) : color.new(color.gray, 30)

// —————————————————————————————————————————————————————————————————————————————
// [3] PLOTTING — Gauge in Pane
// —————————————————————————————————————————————————————————————————————————————

hline(50, "Neutral", color.new(color.gray, 70), hline.style_dashed, 1, display=display.pane)
hline(i_strong_long, "Strong Long", color.new(color.green, 80), hline.style_dotted, 1, display=display.pane)
hline(i_strong_short, "Strong Short", color.new(color.red, 80), hline.style_dotted, 1, display=display.pane)

if i_show_gauge
    plot(score_0_100, "Confluence Score", color=score_color, style=plot.style_histogram, linewidth=8, display=display.pane)
else
    plot(score_0_100, "Confluence Score", color=score_color, linewidth=2, display=display.pane)

// —————————————————————————————————————————————————————————————————————————————
// [4] TABLE — Breakdown on Chart
// —————————————————————————————————————————————————————————————————————————————

pos = switch i_table_pos
    "Top Right" => position.top_right
    "Top Left" => position.top_left
    "Middle Right" => position.middle_right
    "Bottom Right" => position.bottom_right
    => position.top_right

var table tbl = table.new(pos, 3, 10, bgcolor=color.new(color.black, 15), border_width=1, frame_width=1, frame_color=color.new(color.gray, 50))

if i_show_table and barstate.islast
    table.clear(tbl)
    table.cell(tbl, 0, 0, "CONFLUENCE SCORE PRO", text_color=color.white, text_size=size.small, bgcolor=color.new(color.teal, 60))
    table.cell(tbl, 1, 0, str.tostring(score_0_100) + " / 100", text_color=score_0_100 >= 50 ? color.lime : color.red, text_size=size.normal, bgcolor=color.new(color.gray, 70))
    bias = score_0_100 >= i_strong_long ? "LONG" : score_0_100 <= i_strong_short ? "SHORT" : "NEUTRAL"
    table.cell(tbl, 2, 0, bias, text_color=score_0_100 >= 50 ? color.lime : color.red, text_size=size.tiny, bgcolor=color.new(color.gray, 70))

    table.cell(tbl, 0, 1, "MA Trend", text_color=color.gray, text_size=size.tiny)
    table.cell(tbl, 1, 1, ma_bull == 1 ? "✓" : "✗", text_color=ma_bull == 1 ? color.lime : color.gray, text_size=size.tiny)
    table.cell(tbl, 0, 2, "RSI", text_color=color.gray, text_size=size.tiny)
    table.cell(tbl, 1, 2, rsi_bull == 1 ? "✓" : "✗", text_color=rsi_bull == 1 ? color.lime : color.gray, text_size=size.tiny)
    table.cell(tbl, 0, 3, "ADX + DI", text_color=color.gray, text_size=size.tiny)
    table.cell(tbl, 1, 3, adx_bull == 1 ? "✓" : "✗", text_color=adx_bull == 1 ? color.lime : color.gray, text_size=size.tiny)
    table.cell(tbl, 0, 4, "VWAP", text_color=color.gray, text_size=size.tiny)
    table.cell(tbl, 1, 4, vwap_bull == 1 ? "✓" : "✗", text_color=vwap_bull == 1 ? color.lime : color.gray, text_size=size.tiny)
    if i_vol_weight
        table.cell(tbl, 0, 5, "Volume", text_color=color.gray, text_size=size.tiny)
        table.cell(tbl, 1, 5, vol_bull == 1 ? "✓" : "✗", text_color=vol_bull == 1 ? color.lime : color.gray, text_size=size.tiny)
    if i_show_htf and i_htf != "" and not na(score_htf)
        table.cell(tbl, 0, 7, "HTF " + i_htf, text_color=color.silver, text_size=size.tiny)
        table.cell(tbl, 1, 7, str.tostring(math.round(score_htf)), text_color=score_htf >= 50 ? color.lime : color.red, text_size=size.tiny)

// —————————————————————————————————————————————————————————————————————————————
// [5] ALERTS
// —————————————————————————————————————————————————————————————————————————————

alertcondition(ta.crossover(score_0_100, i_strong_long), "Confluence Strong Long", "Confluence Score crossed above " + str.tostring(i_strong_long) + " on {{ticker}}.")
alertcondition(ta.crossunder(score_0_100, i_strong_short), "Confluence Strong Short", "Confluence Score crossed below " + str.tostring(i_strong_short) + " on {{ticker}}.")
alertcondition(ta.cross(score_0_100, 50), "Confluence Neutral Cross", "Confluence Score crossed 50 (neutral) on {{ticker}}.")
